<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreline</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            line-height: 1.4;
            background: #fafafa;
            color: #1a1a1a;
            padding: 16px;
        }

        .container {
            max-width: 640px;
            margin: 0 auto;
        }

        h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        /* Dense layout sections */
        .section {
            margin-bottom: 12px;
        }

        .section-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            margin-bottom: 4px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            font-size: 14px;
            font-family: inherit;
            font-weight: 500;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            outline: none;
            transition: all 0.15s;
        }

        .btn:focus {
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.3);
        }

        /* Test controls */
        .test-controls {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }

        .test-slider {
            width: 100%;
            margin: 8px 0;
        }

        .test-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }

        .hint {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        .hidden { display: none; }

        /* Strip visualization */
        .strip-preview {
            height: 20px;
            background: #1a1a1a;
            border-radius: 3px;
            display: flex;
            overflow: hidden;
            margin: 8px 0;
            position: relative;
        }

        .strip-segment {
            height: 100%;
            transition: width 0.3s ease;
            position: relative;
        }

        .strip-segment.home {
            background: linear-gradient(90deg, var(--home-color-1, #22c55e) 0%, var(--home-color-2, #166534) 100%);
        }

        .strip-segment.away {
            background: linear-gradient(90deg, var(--away-color-1, #3b82f6) 0%, var(--away-color-2, #1d4ed8) 100%);
        }

        .strip-segment.buffer {
            background: #000;
        }

        .strip-segment.divider {
            background: linear-gradient(90deg, #c85000, #ff8c00, #c85000);
            animation: divider-pulse 1.5s ease-in-out infinite;
        }

        @keyframes divider-pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .strip-label {
            position: absolute;
            font-size: 9px;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            white-space: nowrap;
        }

        /* Settings panel */
        .instance-settings {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .settings-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 14px;
            color: #666;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .settings-toggle:hover {
            background: rgba(0,0,0,0.05);
        }

        .settings-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
        }

        .settings-label {
            font-size: 11px;
            color: #666;
            min-width: 80px;
        }

        .settings-value {
            font-family: "SF Mono", Monaco, Consolas, monospace;
            font-size: 12px;
            color: #333;
            min-width: 100px;
        }

        .settings-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 2px;
            outline: none;
        }

        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #0066cc;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Watch teams */
        .watch-teams {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 6px 0;
        }

        .watch-team-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #e0f2fe;
            border: 1px solid #7dd3fc;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-family: monospace;
        }

        .watch-team-tag button {
            background: none;
            border: none;
            cursor: pointer;
            color: #0369a1;
            font-size: 12px;
            padding: 0;
            line-height: 1;
        }

        .watch-team-tag button:hover {
            color: #dc2626;
        }

        .watch-add-form {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        .watch-add-form select {
            padding: 4px 6px;
            font-size: 11px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .watch-add-form button {
            padding: 4px 8px;
            font-size: 11px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .watch-add-form button:disabled {
            background: #86efac;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Scoreline</h1>

        <!-- WLED Instances -->
        <div class="test-controls">
            <div class="section-label" style="display: flex; justify-content: space-between; align-items: center;">
                <span>WLED Instances</span>
                <div style="display: flex; gap: 4px;">
                    <button id="add-wled-btn" class="btn" style="padding: 4px 10px; font-size: 12px; background: #f5f5f5; border: 1px solid #ccc;">+ Add WLED</button>
                    <button id="scan-btn" class="btn" style="padding: 4px 10px; font-size: 12px; background: #f5f5f5; border: 1px solid #ccc;">Scan Network</button>
                </div>
            </div>
            <div id="wled-list"></div>
            <div id="add-wled-form" class="hidden" style="margin-top: 8px; padding: 8px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px;">
                <div style="font-size: 11px; font-weight: 600; color: #166534; margin-bottom: 8px;">Add WLED Device</div>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="add-wled-host" placeholder="IP Address" style="flex: 2; padding: 6px 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                    <input type="number" id="add-wled-start" placeholder="Start" value="0" style="flex: 1; padding: 6px 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                    <input type="number" id="add-wled-end" placeholder="End" style="flex: 1; padding: 6px 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="add-wled-submit" class="btn" style="padding: 4px 12px; font-size: 12px; background: #22c55e; color: white; border: none;">Add</button>
                    <button id="add-wled-cancel" class="btn" style="padding: 4px 12px; font-size: 12px; background: #f5f5f5; border: 1px solid #ccc;">Cancel</button>
                </div>
            </div>
            <div id="discovered-list" class="hidden" style="margin-top: 8px; padding: 8px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 4px;">
                <div style="font-size: 11px; font-weight: 600; color: #0369a1; margin-bottom: 4px;">Discovered on network:</div>
                <div id="discovered-devices"></div>
            </div>
            <div class="hint">Configured in config/settings.yaml</div>
        </div>

        <!-- Test Controls -->
        <div class="test-controls">
            <div class="section-label">Simulator</div>
            <div class="section" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <select id="sim-league" style="flex: 1;">
                    <option value="">League...</option>
                </select>
                <select id="sim-away" style="flex: 1;" disabled>
                    <option value="">Away...</option>
                </select>
                <select id="sim-home" style="flex: 1;" disabled>
                    <option value="">Home...</option>
                </select>
            </div>
            <div class="test-label">
                <span id="sim-away-label">Away 100%</span>
                <span id="test-pct">50%</span>
                <span id="sim-home-label">Home 100%</span>
            </div>
            <input type="range" id="test-slider" class="test-slider"
                   min="0" max="100" value="50">
            <div class="hint">Pick teams and drag to simulate win probability</div>
        </div>
    </div>

    <script>
        // State
        let leagues = [];
        let instanceStates = [];  // From /api/instances

        async function loadInstances() {
            const resp = await fetch('/api/instances');
            instanceStates = await resp.json();
            renderInstanceCards();
        }

        // Track which instance settings panels are expanded
        let expandedSettings = new Set();

        function renderInstanceCards() {
            const list = document.getElementById('wled-list');
            if (instanceStates.length === 0) {
                list.innerHTML = '<div class="hint" style="margin: 8px 0; color: #dc2626;">No WLED instances configured</div>';
                return;
            }

            list.innerHTML = instanceStates.map(inst => {
                const isWatching = inst.watching;
                const hasWatchTeams = (inst.watch_teams || []).length > 0;
                const isOverride = isWatching && hasWatchTeams;  // Manually watching when auto-watch is configured
                const gameInfo = inst.home_team ?
                    `${inst.away_display || inst.away_team} @ ${inst.home_display || inst.home_team}` : '';
                const scoreInfo = inst.home_score !== undefined ?
                    `${inst.away_score}-${inst.home_score}` : '';
                const pctInfo = inst.home_win_pct !== undefined ?
                    `Home: ${(inst.home_win_pct * 100).toFixed(0)}%` : '';

                const isExpanded = expandedSettings.has(inst.host);
                const hostId = inst.host.replace(/\./g, '-');

                // Calculate strip preview segments
                const totalPixels = inst.end - inst.start;
                const minPct = inst.min_team_pct || 0.05;
                const contestedPx = inst.contested_zone_pixels || 6;
                const darkBufferPx = inst.dark_buffer_pixels || 4;
                const battleZone = contestedPx + (darkBufferPx * 2);
                const availablePixels = totalPixels - battleZone;
                const minDignityPixels = Math.round(availablePixels * minPct);

                // Preview at 50/50 by default, or use live win pct if watching
                const previewPct = isWatching && inst.home_win_pct !== undefined ? inst.home_win_pct : 0.5;
                const clampedPct = Math.max(minPct, Math.min(1 - minPct, previewPct));
                const homePixels = Math.round(availablePixels * clampedPct);
                const awayPixels = availablePixels - homePixels;

                // Convert to percentages for CSS
                const homePctWidth = (homePixels / totalPixels * 100).toFixed(1);
                const bufferPctWidth = (darkBufferPx / totalPixels * 100).toFixed(1);
                const dividerPctWidth = (contestedPx / totalPixels * 100).toFixed(1);
                const awayPctWidth = (awayPixels / totalPixels * 100).toFixed(1);

                // Status badges
                const statusBadge = isWatching
                    ? (isOverride
                        ? `<span style="font-size: 10px; color: #d97706; font-weight: 600; background: #fef3c7; padding: 2px 6px; border-radius: 3px;">⚡ OVERRIDE</span>`
                        : `<span style="font-size: 11px; color: #22c55e; font-weight: 600;">● LIVE</span>`)
                    : '';

                // Stop/Resume button
                const stopButton = isWatching
                    ? (hasWatchTeams
                        ? `<button onclick="stopInstance('${inst.host}')" class="btn" style="padding: 4px 12px; font-size: 12px; background: #6366f1; color: white; border: none;">↩ Resume Auto-Watch</button>`
                        : `<button onclick="stopInstance('${inst.host}')" class="btn" style="padding: 4px 12px; font-size: 12px; background: #dc2626; color: white; border: none;">Stop</button>`)
                    : '';

                return `
                <div class="instance-card" style="background: ${isWatching ? (isOverride ? '#fffbeb' : '#f0fdf4') : '#f5f5f5'}; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid ${isWatching ? (isOverride ? '#fcd34d' : '#bbf7d0') : '#e0e0e0'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span>
                            <strong style="font-family: monospace;">${inst.host}</strong>
                            <span style="color: #666; font-size: 12px; margin-left: 8px;">[${inst.start}-${inst.end}] ${totalPixels}px</span>
                        </span>
                        <span style="display: flex; align-items: center; gap: 6px;">
                            ${statusBadge}
                            <button class="settings-toggle" onclick="toggleSettings('${inst.host}')" title="Settings">⚙️</button>
                        </span>
                    </div>

                    ${isWatching ? `
                        <div style="font-size: 13px; margin-bottom: 8px;">
                            <div style="font-weight: 500;">${gameInfo}</div>
                            <div style="color: #666;">${scoreInfo} ${pctInfo ? '| ' + pctInfo : ''}</div>
                        </div>
                    ` : ''}

                    <!-- Game selector - always visible -->
                    <div style="display: flex; gap: 6px; margin-bottom: 8px;">
                        <select id="league-${inst.host}" onchange="loadGamesForInstance('${inst.host}')" style="flex: 1; padding: 4px 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">League...</option>
                            ${leagues.map(l => `<option value="${l.id}">${l.name}</option>`).join('')}
                        </select>
                        <select id="game-${inst.host}" onchange="watchGameFromSelect('${inst.host}')" style="flex: 2; padding: 4px 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;" disabled>
                            <option value="">${isWatching ? 'Switch game...' : 'Select league first...'}</option>
                        </select>
                    </div>

                    ${stopButton}

                    <!-- Settings Panel -->
                    <div id="settings-${hostId}" class="instance-settings ${isExpanded ? '' : 'hidden'}">
                        <div class="section-label" style="margin-bottom: 6px;">Auto-Watch Teams</div>
                        <div class="watch-teams" id="watch-teams-${hostId}">
                            ${(inst.watch_teams || []).map(wt => `
                                <span class="watch-team-tag">
                                    ${wt}
                                    <button onclick="removeWatchTeam('${inst.host}', '${wt}')" title="Remove">×</button>
                                </span>
                            `).join('') || '<span style="font-size: 11px; color: #888;">No teams - games won\'t auto-start</span>'}
                        </div>
                        <div class="watch-add-form">
                            <select id="watch-league-${hostId}" onchange="loadWatchTeams('${inst.host}')">
                                <option value="">League...</option>
                                ${leagues.map(l => `<option value="${l.id}">${l.name}</option>`).join('')}
                            </select>
                            <select id="watch-team-${hostId}" disabled>
                                <option value="">Team...</option>
                            </select>
                            <button onclick="addWatchTeam('${inst.host}')" id="watch-add-btn-${hostId}" disabled>Add</button>
                        </div>
                        <div class="hint" style="margin: 4px 0 12px 0;">When a watched team is playing, their game auto-starts.</div>

                        <div class="section-label" style="margin-bottom: 8px;">Strip Preview</div>
                        <div class="strip-preview" id="preview-${hostId}">
                            <div class="strip-segment home" style="width: ${homePctWidth}%">
                                <span class="strip-label">${homePixels}px</span>
                            </div>
                            <div class="strip-segment buffer" style="width: ${bufferPctWidth}%"></div>
                            <div class="strip-segment divider" style="width: ${dividerPctWidth}%"></div>
                            <div class="strip-segment buffer" style="width: ${bufferPctWidth}%"></div>
                            <div class="strip-segment away" style="width: ${awayPctWidth}%">
                                <span class="strip-label">${awayPixels}px</span>
                            </div>
                        </div>

                        <div class="settings-row">
                            <span class="settings-label">Min Dignity</span>
                            <input type="range" class="settings-slider"
                                   id="dignity-${hostId}"
                                   min="1" max="20" value="${Math.round(minPct * 100)}"
                                   oninput="updateDignityPreview('${inst.host}', this.value); autoSaveInstanceSettings('${inst.host}')">
                            <span class="settings-value" id="dignity-value-${hostId}">${Math.round(minPct * 100)}% (${minDignityPixels}px)</span>
                        </div>

                        <div class="section-label" style="margin: 12px 0 8px 0;">Battle Zone</div>

                        <div class="settings-row">
                            <span class="settings-label">Buffer</span>
                            <input type="range" class="settings-slider"
                                   id="buffer-${hostId}"
                                   min="0" max="20" value="${darkBufferPx}"
                                   oninput="updateBattleZonePreview('${inst.host}'); autoSaveInstanceSettings('${inst.host}')">
                            <span class="settings-value" id="buffer-value-${hostId}">${darkBufferPx}px</span>
                        </div>

                        <div class="settings-row">
                            <span class="settings-label">Divider</span>
                            <input type="range" class="settings-slider"
                                   id="divider-${hostId}"
                                   min="2" max="30" value="${contestedPx}"
                                   oninput="updateBattleZonePreview('${inst.host}'); autoSaveInstanceSettings('${inst.host}')">
                            <span class="settings-value" id="divider-value-${hostId}">${contestedPx}px</span>
                        </div>

                        <div class="hint" style="margin: 4px 0 12px 0;">Buffer = black bars, Divider = animated center. Total: <span id="battlezone-total-${hostId}">${battleZone}px</span></div>

                        <div class="section-label" style="margin: 12px 0 8px 0;">Chase Effect</div>

                        <div class="settings-row">
                            <span class="settings-label">Speed</span>
                            <input type="range" class="settings-slider"
                                   id="chase-speed-${hostId}"
                                   min="50" max="255" value="${inst.chase_speed || 185}"
                                   oninput="document.getElementById('chase-speed-value-${hostId}').textContent = this.value; autoSaveInstanceSettings('${inst.host}')">
                            <span class="settings-value" id="chase-speed-value-${hostId}">${inst.chase_speed || 185}</span>
                        </div>

                        <div class="settings-row">
                            <span class="settings-label">Intensity</span>
                            <input type="range" class="settings-slider"
                                   id="chase-intensity-${hostId}"
                                   min="50" max="255" value="${inst.chase_intensity || 190}"
                                   oninput="document.getElementById('chase-intensity-value-${hostId}').textContent = this.value; autoSaveInstanceSettings('${inst.host}')">
                            <span class="settings-value" id="chase-intensity-value-${hostId}">${inst.chase_intensity || 190}</span>
                        </div>

                        <div class="hint" style="margin: 4px 0;">Lower speed = slower chase. Longer strips need slower values.</div>

                        <div class="section-label" style="margin: 12px 0 8px 0;">Post-Game Action</div>

                        <div class="settings-row">
                            <span class="settings-label">Action</span>
                            <select id="post-action-${hostId}"
                                    onchange="updatePostGameUI('${inst.host}'); autoSavePostGame('${inst.host}')"
                                    style="flex: 1; padding: 4px 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="flash_then_off" ${(inst.post_game_action || 'flash_then_off') === 'flash_then_off' ? 'selected' : ''}>Flash winner, fade off</option>
                                <option value="fade_off" ${inst.post_game_action === 'fade_off' ? 'selected' : ''}>Fade off</option>
                                <option value="off" ${inst.post_game_action === 'off' ? 'selected' : ''}>Off (immediate)</option>
                                <option value="restore" ${inst.post_game_action === 'restore' ? 'selected' : ''}>Restore previous preset</option>
                                <option value="preset" ${inst.post_game_action === 'preset' ? 'selected' : ''}>Switch to preset...</option>
                            </select>
                        </div>

                        <div class="settings-row" id="preset-row-${hostId}" style="${inst.post_game_action === 'preset' ? '' : 'display: none;'}">
                            <span class="settings-label">Preset ID</span>
                            <input type="number" id="post-preset-${hostId}"
                                   value="${inst.post_game_preset_id || ''}"
                                   placeholder="e.g. 1"
                                   onchange="autoSavePostGame('${inst.host}')"
                                   style="width: 80px; padding: 4px 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>

                        <div class="hint" style="margin: 4px 0;">What happens when the game ends. "Restore" returns to whatever was playing before.</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function toggleSettings(host) {
            if (expandedSettings.has(host)) {
                expandedSettings.delete(host);
            } else {
                expandedSettings.add(host);
            }
            renderInstanceCards();
        }

        function updateDignityPreview(host, pctValue) {
            const hostId = host.replace(/\./g, '-');
            const inst = instanceStates.find(i => i.host === host);
            if (!inst) return;

            const minPct = parseInt(pctValue) / 100;
            const totalPixels = inst.end - inst.start;
            const contestedPx = inst.contested_zone_pixels || 6;
            const darkBufferPx = inst.dark_buffer_pixels || 4;
            const battleZone = contestedPx + (darkBufferPx * 2);
            const availablePixels = totalPixels - battleZone;
            const minDignityPixels = Math.round(availablePixels * minPct);

            // Update display
            document.getElementById(`dignity-value-${hostId}`).textContent = `${pctValue}% (${minDignityPixels}px)`;

            // Show both sides at minimum dignity - floor for both teams
            // Layout: [home min] [contested middle] [away min]
            const minPixels = minDignityPixels;
            const contestedPixels = totalPixels - (minPixels * 2);

            const minPctWidth = (minPixels / totalPixels * 100).toFixed(1);
            const contestedPctWidth = (contestedPixels / totalPixels * 100).toFixed(1);

            const preview = document.getElementById(`preview-${hostId}`);
            if (preview) {
                preview.innerHTML = `
                    <div class="strip-segment home" style="width: ${minPctWidth}%">
                        <span class="strip-label">${minPixels}px</span>
                    </div>
                    <div class="strip-segment" style="width: ${contestedPctWidth}%; background: linear-gradient(90deg, rgba(34,197,94,0.2) 0%, rgba(100,100,100,0.3) 50%, rgba(59,130,246,0.2) 100%);">
                        <span class="strip-label" style="color: #888;">contested</span>
                    </div>
                    <div class="strip-segment away" style="width: ${minPctWidth}%">
                        <span class="strip-label">${minPixels}px</span>
                    </div>
                `;
            }
        }

        function updateBattleZonePreview(host) {
            const hostId = host.replace(/\./g, '-');
            const bufferSlider = document.getElementById(`buffer-${hostId}`);
            const dividerSlider = document.getElementById(`divider-${hostId}`);

            const bufferPx = parseInt(bufferSlider.value);
            const dividerPx = parseInt(dividerSlider.value);
            const totalPx = (bufferPx * 2) + dividerPx;

            // Update displays
            document.getElementById(`buffer-value-${hostId}`).textContent = `${bufferPx}px`;
            document.getElementById(`divider-value-${hostId}`).textContent = `${dividerPx}px`;
            document.getElementById(`battlezone-total-${hostId}`).textContent = `${totalPx}px`;
        }

        // Debounced auto-save for instance settings
        const saveTimers = {};
        function autoSaveInstanceSettings(host) {
            // Debounce - wait 500ms after last change before saving
            if (saveTimers[host]) clearTimeout(saveTimers[host]);
            saveTimers[host] = setTimeout(() => saveInstanceSettings(host), 500);
        }

        async function saveInstanceSettings(host) {
            const hostId = host.replace(/\./g, '-');
            const dignitySlider = document.getElementById(`dignity-${hostId}`);
            const bufferSlider = document.getElementById(`buffer-${hostId}`);
            const dividerSlider = document.getElementById(`divider-${hostId}`);
            const chaseSpeedSlider = document.getElementById(`chase-speed-${hostId}`);
            const chaseIntensitySlider = document.getElementById(`chase-intensity-${hostId}`);

            const settings = {
                min_team_pct: parseInt(dignitySlider.value) / 100,
                dark_buffer_pixels: parseInt(bufferSlider.value),
                contested_zone_pixels: parseInt(dividerSlider.value),
                chase_speed: parseInt(chaseSpeedSlider.value),
                chase_intensity: parseInt(chaseIntensitySlider.value),
            };

            const resp = await fetch(`/api/instance/${host}/settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (!resp.ok) {
                console.error('Failed to save settings for', host);
            }
            // Don't reload - let the periodic refresh handle it to avoid UI flicker
        }

        // Post-game settings
        function updatePostGameUI(host) {
            const hostId = host.replace(/\./g, '-');
            const action = document.getElementById(`post-action-${hostId}`).value;
            const presetRow = document.getElementById(`preset-row-${hostId}`);
            presetRow.style.display = action === 'preset' ? '' : 'none';
        }

        const postGameTimers = {};
        function autoSavePostGame(host) {
            if (postGameTimers[host]) clearTimeout(postGameTimers[host]);
            postGameTimers[host] = setTimeout(() => savePostGame(host), 500);
        }

        async function savePostGame(host) {
            const hostId = host.replace(/\./g, '-');
            const action = document.getElementById(`post-action-${hostId}`).value;
            const presetInput = document.getElementById(`post-preset-${hostId}`);
            const presetId = presetInput.value ? parseInt(presetInput.value) : null;

            const settings = {
                action: action,
                preset_id: presetId,
            };

            const resp = await fetch(`/api/instance/${host}/post_game`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (!resp.ok) {
                console.error('Failed to save post-game settings for', host);
            }
        }

        // Watch Teams management
        async function loadWatchTeams(host) {
            const hostId = host.replace(/\./g, '-');
            const leagueSelect = document.getElementById(`watch-league-${hostId}`);
            const teamSelect = document.getElementById(`watch-team-${hostId}`);
            const addBtn = document.getElementById(`watch-add-btn-${hostId}`);
            const league = leagueSelect.value;

            if (!league) {
                teamSelect.innerHTML = '<option value="">Team...</option>';
                teamSelect.disabled = true;
                addBtn.disabled = true;
                return;
            }

            teamSelect.innerHTML = '<option value="">Loading...</option>';
            const resp = await fetch(`/api/teams/${league}`);
            const teams = await resp.json();

            teamSelect.innerHTML = '<option value="">Team...</option>' +
                teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            teamSelect.disabled = false;

            teamSelect.onchange = () => {
                addBtn.disabled = !teamSelect.value;
            };
        }

        async function addWatchTeam(host) {
            const hostId = host.replace(/\./g, '-');
            const leagueSelect = document.getElementById(`watch-league-${hostId}`);
            const teamSelect = document.getElementById(`watch-team-${hostId}`);

            const league = leagueSelect.value;
            const team = teamSelect.value;
            if (!league || !team) return;

            const teamSpec = `${league}:${team}`;

            // Get current watch teams
            const inst = instanceStates.find(i => i.host === host);
            const current = inst?.watch_teams || [];

            // Don't add duplicates
            if (current.includes(teamSpec)) {
                alert('Team already in watch list');
                return;
            }

            const newList = [...current, teamSpec];

            await fetch(`/api/instance/${host}/watch_teams`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ watch_teams: newList })
            });

            // Reset dropdowns
            leagueSelect.value = '';
            teamSelect.innerHTML = '<option value="">Team...</option>';
            teamSelect.disabled = true;
            document.getElementById(`watch-add-btn-${hostId}`).disabled = true;

            await loadInstances();
        }

        async function removeWatchTeam(host, teamSpec) {
            const inst = instanceStates.find(i => i.host === host);
            const current = inst?.watch_teams || [];
            const newList = current.filter(t => t !== teamSpec);

            await fetch(`/api/instance/${host}/watch_teams`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ watch_teams: newList })
            });

            await loadInstances();
        }

        async function loadGamesForInstance(host) {
            const leagueSelect = document.getElementById(`league-${host}`);
            const gameSelect = document.getElementById(`game-${host}`);
            const league = leagueSelect.value;

            if (!league) {
                gameSelect.innerHTML = '<option value="">Select league first...</option>';
                gameSelect.disabled = true;
                return;
            }

            gameSelect.innerHTML = '<option value="">Loading...</option>';
            const resp = await fetch(`/api/games/${league}`);
            const games = await resp.json();

            if (games.length === 0) {
                gameSelect.innerHTML = '<option value="">No games available</option>';
                gameSelect.disabled = true;
            } else {
                gameSelect.innerHTML = games.map(g =>
                    `<option value="${g.id}">${g.away_display} @ ${g.home_display} (${g.detail})</option>`
                ).join('');
                gameSelect.disabled = false;
            }
        }

        // Selecting a game immediately starts watching
        async function watchGameFromSelect(host) {
            const leagueSelect = document.getElementById(`league-${host}`);
            const gameSelect = document.getElementById(`game-${host}`);

            if (!leagueSelect.value || !gameSelect.value) {
                return;  // No selection yet
            }

            await fetch(`/api/instance/${host}/watch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    league: leagueSelect.value,
                    game_id: gameSelect.value
                })
            });

            await loadInstances();
        }

        async function stopInstance(host) {
            await fetch(`/api/instance/${host}/stop`, { method: 'POST' });
            await loadInstances();
        }

        // WLED Discovery
        document.getElementById('scan-btn').addEventListener('click', scanForDevices);

        async function scanForDevices() {
            const btn = document.getElementById('scan-btn');
            const discoveredList = document.getElementById('discovered-list');
            const discoveredDevices = document.getElementById('discovered-devices');

            btn.textContent = 'Scanning...';
            btn.disabled = true;

            try {
                const resp = await fetch('/api/discover');
                const devices = await resp.json();

                if (devices.length === 0) {
                    discoveredDevices.innerHTML = '<div style="color: #666; font-size: 12px;">No WLED devices found</div>';
                } else {
                    discoveredDevices.innerHTML = devices.map(d => `
                        <div class="status-row" style="background: #fff; padding: 6px 10px; margin: 4px 0; border-radius: 4px; border: 1px solid #e0e7ff; display: flex; justify-content: space-between; align-items: center;">
                            <span>
                                <strong>${d.name}</strong>
                                <span style="font-family: monospace; font-size: 12px; color: #666; margin-left: 8px;">${d.ip}</span>
                            </span>
                            ${d.configured
                                ? '<span style="font-size: 11px; color: #22c55e; font-weight: 500;">Added</span>'
                                : `<button onclick="addDevice('${d.ip}', '${d.name}')" class="btn" style="padding: 2px 8px; font-size: 11px; background: #0066cc; color: white; border: none;">Add</button>`
                            }
                        </div>
                    `).join('');
                }
                discoveredList.classList.remove('hidden');
            } catch (e) {
                discoveredDevices.innerHTML = '<div style="color: #dc2626; font-size: 12px;">Scan failed</div>';
                discoveredList.classList.remove('hidden');
            }

            btn.textContent = 'Scan Network';
            btn.disabled = false;
        }

        async function addDevice(ip, name) {
            const resp = await fetch('/api/wled/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ host: ip, start: 0, end: 300 })
            });

            const result = await resp.json();

            if (result.status === 'added') {
                // Refresh both lists
                await loadInstances();
                await scanForDevices();
            }
        }

        // Manual WLED Add Form
        document.getElementById('add-wled-btn').addEventListener('click', () => {
            document.getElementById('add-wled-form').classList.remove('hidden');
            document.getElementById('add-wled-host').focus();
        });

        document.getElementById('add-wled-cancel').addEventListener('click', () => {
            document.getElementById('add-wled-form').classList.add('hidden');
            document.getElementById('add-wled-host').value = '';
            document.getElementById('add-wled-start').value = '0';
            document.getElementById('add-wled-end').value = '';
        });

        document.getElementById('add-wled-submit').addEventListener('click', async () => {
            const host = document.getElementById('add-wled-host').value.trim();
            const start = parseInt(document.getElementById('add-wled-start').value) || 0;
            const end = parseInt(document.getElementById('add-wled-end').value);

            if (!host) {
                alert('Please enter an IP address');
                return;
            }
            if (isNaN(end)) {
                alert('Please enter the end LED index');
                return;
            }

            const btn = document.getElementById('add-wled-submit');
            btn.textContent = 'Adding...';
            btn.disabled = true;

            try {
                const resp = await fetch('/api/wled/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ host, start, end })
                });

                const result = await resp.json();

                if (result.status === 'added') {
                    // Clear form and hide
                    document.getElementById('add-wled-form').classList.add('hidden');
                    document.getElementById('add-wled-host').value = '';
                    document.getElementById('add-wled-start').value = '0';
                    document.getElementById('add-wled-end').value = '';
                    // Refresh list
                    await loadInstances();
                } else if (result.status === 'exists') {
                    alert('This WLED device is already configured');
                }
            } catch (e) {
                alert('Failed to add device');
            }

            btn.textContent = 'Add';
            btn.disabled = false;
        });

        // Simulator controls
        const simLeague = document.getElementById('sim-league');
        const simAway = document.getElementById('sim-away');
        const simHome = document.getElementById('sim-home');
        const testSlider = document.getElementById('test-slider');

        async function updateSimulator() {
            const league = simLeague.value;
            const away = simAway.value;
            const home = simHome.value;
            const pct = testSlider.value;

            if (league && away && home) {
                document.getElementById('test-pct').textContent = pct + '%';
                await fetch('/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pct: parseInt(pct),
                        league: league,
                        home: home,
                        away: away
                    })
                });
            }
        }

        simLeague.addEventListener('change', async () => {
            const league = simLeague.value;
            if (!league) {
                simAway.disabled = true;
                simHome.disabled = true;
                return;
            }

            const resp = await fetch(`/api/teams/${league}`);
            const teams = await resp.json();

            const options = '<option value="">Pick team...</option>' +
                teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

            simAway.innerHTML = options;
            simHome.innerHTML = options;
            simAway.disabled = false;
            simHome.disabled = false;
        });

        simAway.addEventListener('change', () => {
            document.getElementById('sim-away-label').textContent =
                simAway.options[simAway.selectedIndex]?.text || 'Away';
            updateSimulator();
        });

        simHome.addEventListener('change', () => {
            document.getElementById('sim-home-label').textContent =
                simHome.options[simHome.selectedIndex]?.text || 'Home';
            updateSimulator();
        });

        testSlider.addEventListener('input', () => updateSimulator());

        // Initialize simulator leagues dropdown immediately
        (async function initSimulator() {
            const resp = await fetch('/api/leagues');
            const simLeagues = await resp.json();
            simLeague.innerHTML = '<option value="">League...</option>' +
                simLeagues.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
        })();

        // Initial load
        async function init() {
            // Load leagues (needed for instance card dropdowns)
            const resp = await fetch('/api/leagues');
            leagues = await resp.json();

            // Load instances
            await loadInstances();

            // Periodic refresh for live scores (skip if user is interacting with form)
            setInterval(() => {
                const active = document.activeElement;
                if (active && active.matches('input, select, textarea')) {
                    return; // Don't refresh while user is typing/selecting
                }
                loadInstances();
            }, 10000);
        }

        init();

        // Global keyboard shortcuts (respecting input focus)
        document.addEventListener('keydown', (e) => {
            if (e.target.matches('input, select, textarea')) {
                return;
            }
            // Could add global shortcuts here
        });
    </script>
</body>
</html>
